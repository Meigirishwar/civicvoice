<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì Civic Voice</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
          font-family: 'Poppins', sans-serif;
          background: linear-gradient(to bottom right, #e0f2fe, #ffffff, #dbeafe);
          overflow-x: hidden;
        }
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card {
          background: rgba(255, 255, 255, 0.85);
          backdrop-filter: blur(10px);
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
          transition: transform 0.2s, box-shadow 0.3s;
        }
        .card:hover { transform: translateY(-4px); box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15); }
        #modalDesc { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>

<body class="min-h-screen text-gray-800">

<!-- Navbar -->
<nav class="fixed top-0 left-0 right-0 bg-white/70 backdrop-blur-md shadow-sm px-6 py-4 flex justify-between items-center z-50">
    <h1 class="text-2xl font-extrabold text-blue-700">üåø Civic Voice ‚Äì Admin Panel</h1>
    <div class="flex space-x-6">
        <a href="/dashboard" class="text-blue-600 font-semibold hover:underline">Citizen View</a>
        <a href="/logout" class="text-red-600 font-semibold hover:underline">Logout</a>
    </div>
</nav>

<!-- Main Content -->
<main class="pt-28 px-8 fade-in">
    <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">Welcome, Admin üëã</h2>

    <!-- Stats -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
        <div class="card rounded-2xl p-6 text-center">
            <p class="text-yellow-500 text-3xl font-bold" th:text="${pending}">0</p>
            <p class="text-gray-600 mt-2 font-medium">Pending</p>
        </div>
        <div class="card rounded-2xl p-6 text-center">
            <p class="text-purple-600 text-3xl font-bold" th:text="${inProgress}">0</p>
            <p class="text-gray-600 mt-2 font-medium">In Progress</p>
        </div>
        <div class="card rounded-2xl p-6 text-center">
            <p class="text-green-600 text-3xl font-bold" th:text="${completed}">0</p>
            <p class="text-gray-600 mt-2 font-medium">Completed</p>
        </div>
        <div class="card rounded-2xl p-6 text-center">
            <p class="text-red-600 text-3xl font-bold" th:text="${rejected}">0</p>
            <p class="text-gray-600 mt-2 font-medium">Rejected</p>
        </div>
    </section>

    <!-- Search + Table -->
    <section class="bg-white/80 backdrop-blur-md rounded-2xl shadow-md p-6 overflow-x-auto">
        <div class="flex justify-between items-center mb-5">
            <h3 class="text-2xl font-semibold text-gray-800">Active Complaints</h3>
            <form method="get" th:action="@{/admin/dashboard}" class="flex items-center space-x-2">
                <input type="text" name="query" th:value="${query}" placeholder="Search by title, user, or category..."
                       class="border border-gray-300 rounded-lg px-3 py-2 w-72 focus:ring-2 focus:ring-blue-300">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Search</button>
            </form>
        </div>

        <table class="min-w-full text-sm text-left text-gray-700">
            <thead class="text-xs uppercase bg-blue-100 text-blue-800">
            <tr>
                <th class="px-6 py-3">ID</th>
                <th class="px-6 py-3">User</th>
                <th class="px-6 py-3">Title</th>
                <th class="px-6 py-3">Category</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3 text-center">Action</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="complaint : ${complaints}"
                class="border-b hover:bg-blue-50 transition cursor-pointer"
                th:data-id="${complaint.id}"
                th:data-title="${complaint.title}"
                th:data-desc="${complaint.description}"
                th:data-media="${complaint.mediaPath}"
                onclick="openModalFromRow(event, this)">
                <td class="px-6 py-4" th:text="${complaint.id}"></td>
                <td class="px-6 py-4" th:text="${complaint.user.fullName}"></td>
                <td class="px-6 py-4 font-medium text-gray-800" th:text="${complaint.title}"></td>
                <td class="px-6 py-4" th:text="${complaint.category}"></td>
                <td class="px-6 py-4 font-semibold" th:text="${complaint.status}"></td>
                <td class="px-6 py-4 text-center space-x-2">

                    <!-- Pending -->
                    <div th:if="${complaint.status.name() == 'PENDING'}" class="inline-block" onclick="event.stopPropagation()">
                        <button type="button"
                                th:onclick="'updateComplaintStatus(' + ${complaint.id} + ', \'start\')'"
                                class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition">Start</button>
                        <button type="button"
                                th:onclick="'openRejectModal(' + ${complaint.id} + ')'"
                                class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition ml-2">Reject</button>
                    </div>

                    <!-- In Progress -->
                    <div th:if="${complaint.status.name() == 'IN_PROGRESS'}" class="inline-block" onclick="event.stopPropagation()">
                        <button type="button"
                                th:onclick="'updateComplaintStatus(' + ${complaint.id} + ', \'complete\')'"
                                class="bg-green-600 text-white px-3 py-1 rounded-lg hover:bg-green-700 transition">Complete</button>
                    </div>

                    <!-- Completed -->
                    <button th:if="${complaint.status.name() == 'COMPLETED'}"
                            class="bg-gray-400 text-white px-3 py-1 rounded-lg cursor-not-allowed">Done</button>
                </td>
            </tr>
            </tbody>
        </table>
    </section>
</main>

<!-- Complaint Modal -->
<div id="complaintModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-11/12 md:w-3/4 max-h-[90vh] overflow-y-auto shadow-2xl">
        <h2 id="modalTitle" class="text-2xl font-bold text-blue-700 mb-3"></h2>
        <p id="modalDesc" class="text-gray-700 mb-4"></p>
        <div id="modalMediaContainer" class="hidden">
            <h3 class="text-lg font-semibold mb-2">Attached File:</h3>
            <div id="mediaDisplay"></div>
        </div>
        <div class="text-center mt-6">
            <button onclick="closeModal()" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition">Close</button>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
    <div class="bg-white rounded-xl p-6 w-96 shadow-2xl">
        <h2 class="text-xl font-bold text-red-600 mb-3">Reject Complaint</h2>
        <form id="rejectForm">
            <input type="hidden" id="rejectComplaintId">
            <textarea name="reason" placeholder="Enter rejection reason..." required
                      class="w-full border border-gray-300 rounded-lg p-2 mb-4 focus:ring-2 focus:ring-red-300"></textarea>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeRejectModal()"
                        class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400 transition">Cancel</button>
                <button type="submit"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Reject</button>
            </div>
        </form>
    </div>
</div>

<!-- ‚úÖ Scripts -->
<script>
    document.addEventListener("DOMContentLoaded", () => {

      // Complaint modal
      window.openModalFromRow = (event, row) => {
        if (event.target.tagName === 'BUTTON' || event.target.closest('form')) return;
        const { id, title, desc, media } = row.dataset;
        const modal = document.getElementById('complaintModal');
        modal.classList.remove('hidden');
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalDesc').innerText = desc;

        const container = document.getElementById('modalMediaContainer');
        const display = document.getElementById('mediaDisplay');
        display.innerHTML = '';
        if (media && media !== 'null' && media !== '') {
          const isVideo = media.toLowerCase().endsWith('.mp4');
          container.classList.remove('hidden');
          display.innerHTML = isVideo
            ? `<video controls class="rounded-lg shadow-md w-full max-h-96"><source src="${media}" type="video/mp4"></video>`
            : `<img src="${media}" alt="Media" class="rounded-lg shadow-md w-full max-h-96 object-contain">`;
        } else container.classList.add('hidden');
      };

      window.closeModal = () => {
        document.getElementById('complaintModal').classList.add('hidden');
        document.querySelectorAll('video').forEach(v => v.pause());
      };

      // Reject modal
      window.openRejectModal = id => {
        document.getElementById('rejectComplaintId').value = id;
        document.getElementById('rejectModal').classList.remove('hidden');
      };

      window.closeRejectModal = () => {
        document.getElementById('rejectModal').classList.add('hidden');
      };

      // ‚úÖ AJAX reject
      document.getElementById('rejectForm').addEventListener('submit', async e => {
        e.preventDefault();
        const id = document.getElementById('rejectComplaintId').value;
        const reason = e.target.querySelector('textarea[name="reason"]').value.trim();
        if (!reason) return alert("Please enter a reason before rejecting.");

        try {
          const res = await fetch(`/admin/complaints/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ action: 'reject', reason })
          });
          const text = await res.text();
          console.log("Reject response:", text);
          if (text === "SUCCESS") {
            alert("‚úÖ Complaint rejected successfully!");
            closeRejectModal();
            window.location.reload();
          } else alert("‚ö†Ô∏è Failed: " + text);
        } catch (err) {
          alert("Network error: " + err);
        }
      });

      // ‚úÖ AJAX start/complete
      window.updateComplaintStatus = async (id, action) => {
        try {
          const res = await fetch(`/admin/complaints/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ action })
          });
          const text = await res.text();
          console.log("Status response:", text);
          if (text === "SUCCESS") {
            alert(`‚úÖ Complaint ${action === 'start' ? 'started' : 'completed'} successfully!`);
            window.location.reload();
          } else {
            alert("‚ö†Ô∏è Failed: " + text);
          }
        } catch (err) {
          console.error(err);
          alert("Network error: " + err.message);
        }
      };
    });
</script>

</body>
</html>
